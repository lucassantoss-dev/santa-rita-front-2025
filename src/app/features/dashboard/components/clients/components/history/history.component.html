<div class="history-modal">
  <div class="modal-header">
    <div class="header-content">
      <div class="header-text">
        <h2 mat-dialog-title>
          {{ data.preSelectedClient ? 'Criar Histórico - ' + data.preSelectedClient.nome + ' ' + data.preSelectedClient.sobrenome : 'Criar Histórico de Pagamento' }}
        </h2>
        <p class="header-subtitle">
          {{ data.preSelectedClient ? 'Configure o período e método de pagamento' : 'Configure o período e método de pagamento para o cliente' }}
        </p>
      </div>
    </div>
    <button mat-icon-button (click)="onCancel()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div mat-dialog-content class="modal-content">
    <div *ngIf="loadingSearch && searchResults.length === 0" class="loading-section">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Buscando clientes...</p>
    </div>

    <form [formGroup]="historyForm" (ngSubmit)="onSubmit()" class="history-form">
      <!-- Seleção de Cliente -->
      <div class="form-section">
        <div class="section-title">
          <mat-icon>person</mat-icon>
          <span>Cliente</span>
        </div>

        <div class="client-selection">
          <!-- Cliente selecionado -->
          <div *ngIf="selectedClient" class="selected-client">
            <div class="client-card">
              <div class="client-info">
                <div class="client-name">{{ selectedClient.nome }} {{ selectedClient.sobrenome }}</div>
                <div class="client-details">{{ selectedClient.quadra }}{{ selectedClient.numero }} • {{ selectedClient.tipo }}</div>
              </div>
              <!-- Só mostrar botão de limpar se não é pré-selecionado -->
              <button type="button"
                      mat-icon-button
                      (click)="clearClientSelection()"
                      class="clear-btn"
                      *ngIf="!data.preSelectedClient">
                <mat-icon>close</mat-icon>
              </button>
              <!-- Indicador de cliente pré-selecionado -->
              <mat-icon *ngIf="data.preSelectedClient" class="locked-icon"
                        matTooltip="Cliente selecionado automaticamente">
                lock
              </mat-icon>
            </div>
          </div>

          <!-- Campo de busca - só mostrar se não há cliente pré-selecionado -->
          <div *ngIf="!selectedClient && !data.preSelectedClient" class="search-section">
            <mat-form-field appearance="outline" class="search-field">
              <mat-label>Digite o nome do cliente</mat-label>
              <input matInput
                     placeholder="Ex: João Silva, Maria..."
                     (input)="onClientSearch(searchInput.value)"
                     #searchInput>
              <mat-icon matSuffix [class.loading]="loadingSearch">
                {{ loadingSearch ? 'hourglass_empty' : 'search' }}
              </mat-icon>
              <mat-hint>Digite pelo menos 2 caracteres para buscar</mat-hint>
            </mat-form-field>

            <!-- Resultados da busca -->
            <div *ngIf="searchResults.length > 0" class="search-results">
              <div class="results-header">
                <span>{{ searchResults.length }} cliente(s) encontrado(s)</span>
              </div>
              <div class="results-list">
                <div *ngFor="let client of searchResults"
                     class="result-item"
                     (click)="onClientSelect(client)">
                  <div class="result-content">
                    <div class="result-name">{{ client.nome }} {{ client.sobrenome }}</div>
                    <div class="result-details">{{ client.quadra }}{{ client.numero }} • {{ client.tipo }}</div>
                  </div>
                  <mat-icon class="select-icon">keyboard_arrow_right</mat-icon>
                </div>
              </div>
            </div>

            <!-- Estado vazio -->
            <div *ngIf="searchInput.value && searchInput.value.length >= 2 && searchResults.length === 0 && !loadingSearch"
                 class="empty-state">
              <mat-icon>search_off</mat-icon>
              <p>Nenhum cliente encontrado</p>
              <small>Tente buscar por outro nome</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Período -->
      <div class="form-section">
        <div class="section-title">
          <mat-icon>date_range</mat-icon>
          <span>Período do Contrato</span>
        </div>
        <div class="date-row">
          <mat-form-field appearance="outline" class="date-field">
            <mat-label>Data de Contratação</mat-label>
            <input matInput
                   [matDatepicker]="startPicker"
                   formControlName="startDate"
                   required
                   placeholder="dd/mm/aaaa"
                   (input)="onDateInput($event, 'startDate')"
                   (blur)="onDateInput($event, 'startDate')">
            <mat-hint>Quando o cliente contratou o plano</mat-hint>
            <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
            <mat-error *ngIf="historyForm.get('startDate')?.hasError('required')">
              Data de contratação obrigatória
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="date-field">
            <mat-label>Data Final</mat-label>
            <input matInput
                   [matDatepicker]="endPicker"
                   formControlName="endDate"
                   required
                   placeholder="dd/mm/aaaa"
                   (input)="onDateInput($event, 'endDate')"
                   (blur)="onDateInput($event, 'endDate')">
            <mat-hint>Até quando gerar o histórico</mat-hint>
            <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
            <mat-error *ngIf="historyForm.get('endDate')?.hasError('required')">
              Data final obrigatória
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Configurações de Pagamento -->
      <div class="form-section">
        <div class="section-title">
          <mat-icon>payment</mat-icon>
          <span>Configurações de Pagamento</span>
        </div>
        <div class="payment-row">
          <mat-form-field appearance="outline" class="payment-method-field">
            <mat-label>Método de Pagamento</mat-label>
            <mat-select formControlName="paymentMethod" required>
              <mat-option *ngFor="let method of paymentMethods" [value]="method.value">
                {{ method.label }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="historyForm.get('paymentMethod')?.hasError('required')">
              Método de pagamento obrigatório
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="payment-status-field">
            <mat-label>Status Padrão</mat-label>
            <mat-select formControlName="defaultStatus" required>
              <mat-option *ngFor="let status of paymentStatuses" [value]="status.value">
                <mat-icon>{{ status.icon }}</mat-icon>
                {{ status.label }}
              </mat-option>
            </mat-select>
            <mat-hint>Como os pagamentos serão criados</mat-hint>
            <mat-error *ngIf="historyForm.get('defaultStatus')?.hasError('required')">
              Status padrão obrigatório
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="amount-field">
            <mat-label>Valor Mensal</mat-label>
            <input matInput type="number" step="0.01" min="0.01" formControlName="amount" required>
            <span matTextPrefix>R$ </span>
            <mat-hint>Valor que será cobrado mensalmente</mat-hint>
            <mat-error *ngIf="historyForm.get('amount')?.hasError('required')">
              Valor obrigatório
            </mat-error>
            <mat-error *ngIf="historyForm.get('amount')?.hasError('min')">
              Valor deve ser maior que R$ 0,00
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Preview -->
      <div class="preview-section" *ngIf="selectedClient && historyForm.get('startDate')?.value && historyForm.get('endDate')?.value && historyForm.get('amount')?.value">
        <div class="preview-title">
          <mat-icon>preview</mat-icon>
          <span>Resumo do Histórico</span>
        </div>
        <div class="preview-content">
          <div class="preview-item">
            <span class="preview-label">Cliente:</span>
            <span class="preview-value">{{ getSelectedClientName() }}</span>
          </div>
          <div class="preview-item">
            <span class="preview-label">Período:</span>
            <span class="preview-value">{{ formatDateRange() }}</span>
          </div>
          <div class="preview-item">
            <span class="preview-label">Método:</span>
            <span class="preview-value">{{ getPaymentMethodLabel() }}</span>
          </div>
          <div class="preview-item">
            <span class="preview-label">Status Padrão:</span>
            <span class="preview-value">{{ getStatusLabel() }}</span>
          </div>
          <div class="preview-item">
            <span class="preview-label">Valor:</span>
            <span class="preview-value highlight">{{ formatCurrency(historyForm.value.amount) }}</span>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div mat-dialog-actions class="modal-actions">
    <button mat-button (click)="onCancel()" [disabled]="loading" class="cancel-btn">
      <mat-icon>cancel</mat-icon>
      Cancelar
    </button>
    <button
      mat-raised-button
      color="primary"
      (click)="onSubmit()"
      [disabled]="!selectedClient || historyForm.invalid || loading"
      class="submit-btn"
    >
      <mat-icon *ngIf="!loading">save</mat-icon>
      <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
      <span *ngIf="!loading">Criar Histórico</span>
      <span *ngIf="loading">Criando...</span>
    </button>
  </div>
</div>

<!-- Dialog de confirmação personalizado -->
<div class="custom-confirmation-dialog" *ngIf="showSuccessDialog">
  <div class="confirmation-overlay" (click)="showSuccessDialog = false"></div>
  <div class="confirmation-content">
    <div class="confirmation-header">
      <h3>Histórico criado com sucesso!</h3>
    </div>
    <div class="confirmation-body">
      <p>Deseja criar histórico para outro cliente?</p>
    </div>
    <div class="confirmation-actions">
      <button
        mat-button
        color="primary"
        (click)="continueCreating()"
        class="action-button confirm-button">
        <mat-icon>add</mat-icon>
        Continuar
      </button>
      <button
        mat-button
        (click)="closeModal()"
        class="action-button cancel-button">
        <mat-icon>close</mat-icon>
        Fechar
      </button>
    </div>
  </div>
</div>
