<div class="clients-container">
  <!-- Header da Página -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          <mat-icon>people</mat-icon>
          Gestão de Clientes
        </h1>
        <p class="page-subtitle">Gerencie todos os clientes cadastrados no cemitério</p>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" class="primary-action-btn" (click)="onCreate()">
          <mat-icon>person_add</mat-icon>
          Novo Cliente
        </button>

        <button mat-raised-button color="primary" class="primary-action-btn" (click)="onCreateHistory()">
          <mat-icon>person_add</mat-icon>
          Criar histórico
        </button>

        <button mat-raised-button color="primary" class="primary-action-btn" (click)="openClientPlanAssociation()">
          <mat-icon>link</mat-icon>
          Associar Cliente a Planos
        </button>
      </div>
    </div>
  </div>

  <!-- Estatísticas Rápidas -->
  <div class="stats-grid">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>people</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{totalClients}}</h3>
            <p>Total de Clientes</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>today</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{newClientsThisMonth}}</h3>
            <p>Novos este Mês</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>credit_card</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{activeCards}}</h3>
            <p>Carteirinhas Ativas</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon">
            <mat-icon>description</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{certificatesGenerated}}</h3>
            <p>Certificados</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card> -->
  </div>

  <!-- Seção de Filtros -->
  <mat-card class="filters-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>filter_list</mat-icon>
        Filtros de Pesquisa
      </mat-card-title>
      <button mat-icon-button (click)="toggleFilters()" class="toggle-filters-btn">
        <mat-icon>{{filtersExpanded ? 'expand_less' : 'expand_more'}}</mat-icon>
      </button>
    </mat-card-header>
    <mat-card-content [@expandCollapse]="filtersExpanded ? 'expanded' : 'collapsed'">
      <div class="filters-grid">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Nome do Cliente</mat-label>
          <input matInput [(ngModel)]="nameFilter" placeholder="Digite o nome..." (keyup.enter)="onSearch()">
          <mat-icon matSuffix>person</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Quadra</mat-label>
          <input matInput [(ngModel)]="blockFilter" placeholder="Ex: A, B, C..." (keyup.enter)="onSearch()">
          <mat-icon matSuffix>grid_view</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Número</mat-label>
          <input matInput [(ngModel)]="numberFilter" placeholder="Ex: 123, 456..." (keyup.enter)="onSearch()">
          <mat-icon matSuffix>numbers</mat-icon>
        </mat-form-field>
      </div>

      <div class="filters-actions">
        <button mat-raised-button color="primary" (click)="onSearch()" class="filter-btn" [disabled]="loading">
          <mat-icon>search</mat-icon>
          <span *ngIf="!loading">Pesquisar</span>
          <span *ngIf="loading">Buscando...</span>
        </button>
        <button mat-stroked-button (click)="clearFilters()" class="filter-btn" [disabled]="loading">
          <mat-icon>clear</mat-icon>
          Limpar Filtros
        </button>
      </div>

      <!-- Active Filters Display -->
      <!-- <div class="active-filters" *ngIf="isSearchActive">
        <span class="filter-label">Filtros ativos:</span>
        <div class="filter-tags">
          <span class="filter-tag" *ngIf="nameFilter.trim()">
            <mat-icon>person</mat-icon>
            Nome: {{nameFilter}}
          </span>
          <span class="filter-tag" *ngIf="blockFilter.trim()">
            <mat-icon>grid_view</mat-icon>
            Quadra: {{blockFilter}}
          </span>
          <span class="filter-tag" *ngIf="numberFilter.trim()">
            <mat-icon>numbers</mat-icon>
            Número: {{numberFilter}}
          </span>
        </div>
      </div> -->
    </mat-card-content>
  </mat-card>

  <!-- Resultados e Tabela -->
  <mat-card class="results-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>{{isSearchActive ? 'search' : 'list'}}</mat-icon>
        {{isSearchActive ? 'Resultados da Busca' : 'Lista de Clientes'}}
      </mat-card-title>
      <div class="results-info">
        <span class="results-count" *ngIf="!isSearchActive">{{filteredCount}} de {{totalCount}} clientes</span>
        <span class="results-count" *ngIf="isSearchActive">{{filteredCount}} cliente(s) encontrado(s)</span>
        <span *ngIf="isSearchActive" class="search-indicator">
          <mat-icon>filter_alt</mat-icon>
          Busca ativa
        </span>
      </div>
    </mat-card-header>
    <mat-card-content>
      <!-- Loading State -->
      <div *ngIf="loading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Carregando clientes...</p>
      </div>

      <!-- Visualização em Tabela -->
      <div *ngIf="!loading" class="table-view">
        <div class="table-wrapper">
          <table mat-table [dataSource]="pagedData" class="modern-table" matSort>
            <!-- Coluna Avatar/Status -->
            <ng-container matColumnDef="avatar">
              <th mat-header-cell *matHeaderCellDef mat-sort-header></th>
              <td mat-cell *matCellDef="let element">
                <div class="client-avatar">
                  <mat-icon>person</mat-icon>
                </div>
              </td>
            </ng-container>

            <!-- Coluna de Informações Principais -->
            <ng-container matColumnDef="client-info">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Cliente</th>
              <td mat-cell *matCellDef="let element">
                <div class="client-info">
                  <h4>{{ element.nome }} {{ element.sobrenome }}</h4>
                  <p>{{ element.endereco }}</p>
                  <div class="client-tags">
                    <span class="status-tag" [ngClass]="getStatusClass(element.status)">
                      {{ element.status || 'Ativo' }}
                    </span>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Coluna de Localização -->
            <ng-container matColumnDef="location">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Localização</th>
              <td mat-cell *matCellDef="let element">
                <div class="location-info">
                  <div class="location-item">
                    <mat-icon>grid_view</mat-icon>
                    <span>Quadra {{ element.quadra }}</span>
                  </div>
                  <div class="location-item">
                    <mat-icon>numbers</mat-icon>
                    <span>Nº {{ element.numero }}</span>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Coluna de Tipo -->
            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
              <td mat-cell *matCellDef="let element">
                <div class="type-badge" [ngClass]="getTypeClass(element.tipo)">
                  <mat-icon>{{ getTypeIcon(element.tipo) }}</mat-icon>
                  <span>{{ element.tipo }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Coluna de Ações -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Ações</th>
              <td mat-cell *matCellDef="let element">
                <div class="actions-container">
                  <button mat-icon-button class="action-btn edit-btn"
                          title="Editar Cliente"
                          (click)="onEdit(element._id)"
                          matTooltip="Editar Cliente">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button class="action-btn card-btn"
                          title="Gerar Carteirinha"
                          (click)="downloadCard(element._id)"
                          matTooltip="Gerar Carteirinha">
                    <mat-icon>badge</mat-icon>
                  </button>
                  <button mat-icon-button class="action-btn certificate-btn"
                          title="Gerar Certificado"
                          (click)="downloadCertificate(element._id)"
                          matTooltip="Gerar Certificado">
                    <mat-icon>description</mat-icon>
                  </button>
                  <button mat-icon-button class="action-btn delete-btn"
                          title="Excluir Cliente"
                          (click)="onDelete(element._id)"
                          matTooltip="Excluir Cliente">
                    <mat-icon>delete</mat-icon>
                  </button>
                  <button mat-icon-button class="action-btn view-btn"
                          title="Visualizar Pagamentos"
                          (click)="onViewPayments(element._id)"
                          matTooltip="Visualizar Pagamentos">
                    <mat-icon>payment</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                class="table-row"></tr>
          </table>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!loading && pagedData?.length === 0" class="empty-state">
        <mat-icon>people_outline</mat-icon>
        <h3>Nenhum cliente encontrado</h3>
        <p>Não há clientes que correspondam aos filtros aplicados.</p>
      </div>

      <!-- Paginação -->
      <div *ngIf="!loading && pagedData && pagedData.length > 0" class="pagination-container">
        <mat-paginator
          [length]="filteredCount"
          [pageSize]="pageSize"
          [pageIndex]="pageIndex"
          [pageSizeOptions]="pageSizeOptions"
          [showFirstLastButtons]="true"
          (page)="onPageChange($event)">
        </mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>
</div>
